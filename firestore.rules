/**
 * @file firestore.rules
 * @description Security rules for the StarTak curtain store Firestore database.
 *
 * @section Core Philosophy
 * This ruleset enforces a public-access model for orders to facilitate a
 * login-free checkout and a public admin dashboard. Customer data is not
 * stored in separate collections, but rather as part of the order itself.
 *
 * @section Data Structure
 * - `/orders`: A global collection where all orders are stored. It's publicly
 *   writable for new checkouts and publicly readable/updatable for the admin
 *   dashboard to function.
 * - Other collections like `/curtains` and `/customization_options` are
 *   publicly readable catalogs.
 *
 * @section Key Security Decisions
 * - Public Order Management: The `/orders` collection allows anyone to `create` a new
 *   document, enabling checkout for guests. It also allows anyone to `get`, `list`,
 *   and `update` to allow the public-facing dashboard and order tracking pages
 *   to function correctly without login.
 * - Default Deny: Any path not explicitly defined in these rules is inaccessible.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Order Management
    // -------------------------------------------------------------------------

    /**
     * @description Manages orders. Allows anyone to create an order, and allows
     * anyone to read/update for the public dashboard and customer tracking.
     * @path /orders/{orderId}
     * @allow (create) Any user, signed-in or anonymous, can create an order.
     * @allow (get, list, update) Allows public dashboard and tracking to function.
     * @principle Enable public checkout and a public dashboard.
     */
    match /orders/{orderId} {
      allow get, list, update: if true; // Anyone can read/update for the public dashboard and tracking
      allow create: if true; // Anyone can create a new order
      allow delete: if false; // Disallow deleting orders
    }
    
    // -------------------------------------------------------------------------
    // Product Catalog & Other Collections
    // -------------------------------------------------------------------------

    match /curtains/{curtainId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    match /customization_options/{customizationOptionId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
    
    match /contact_form_entries/{contactFormEntryId} {
      allow create: if true;
      allow get, list, update, delete: if false;
    }

    // Explicitly deny access to collections that are no longer in use
    // to ensure security.
    match /customers/{customerId} {
      allow read, write: if false;
    }
    match /verification_codes/{verificationCodeId} {
        allow read, write: if false;
    }
  }
}
