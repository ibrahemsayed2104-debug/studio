/**
 * This ruleset is for the 'Fabrics' curtain store application.
 *
 * Core Philosophy:
 * With user authentication disabled, the security model is simplified. Data is either public,
 * write-only, or accessible via a known identifier (like an order ID).
 *
 * Data Structure:
 * - /curtains: Public catalog, read-only for clients.
 * - /contact_form_entries: Write-only for public contact form.
 * - /orders: Allows creation by anyone, but individual orders are only readable
 *   if you know the specific `orderId`. Listing all orders is denied.
 *
 * Key Security Decisions:
 * - Public Catalog: `/curtains` is publicly readable. Writes are disabled.
 * - Write-Only Contact Form: `/contact_form_entries` allows creation, denies all reads.
 * - Order Security:
 *   - Anyone can create an order (`create: if true`).
 *   - A specific order can only be read (`get: if true`). This allows a customer to
 *     track their order if they have the ID, but prevents anyone from browsing all orders.
 *   - Listing all documents in the `orders` collection is denied (`list: if false`). This
 *     is a crucial privacy and security measure.
 *   - Updates are ONLY allowed to change status from 'تم الشحن' to 'تم التوصيل'.
 *   - Deletes are disabled from the client-side for data integrity.
 * - Deny by Default: Any operation not explicitly granted is denied.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Publicly readable catalog of curtain products. Writes are disabled.
     */
    match /curtains/{curtainId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Stores submissions from the public contact form.
     */
    match /contact_form_entries/{contactFormEntryId} {
      allow create: if true;
      allow get, list, update, delete: if false;
    }
    
    /**
     * @description Stores customer orders.
     * @path /orders/{orderId}
     * @allow (create) Anyone can place an order.
     * @allow (get) Anyone can view a specific order if they know the ID.
     * @allow (update) An update is only allowed to change the status from 'Shipped' to 'Delivered'.
     * @deny (list) Listing all orders is denied for privacy.
     * @deny (delete) Client-side deletes are denied.
     */
    match /orders/{orderId} {
      allow create, get: if true;
      allow update: if request.resource.data.status == 'تم التوصيل' && resource.data.status == 'تم الشحن';
      allow list, delete: if false;
    }
  }
}
